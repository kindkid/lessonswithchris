<html>
  <head>
    <style>
      #blah {
       border: 1px solid black;
      }
    </style>
    <script>
      X_MIN = -2
      X_MAX = 1
      Y_MIN = -1.5
      Y_MAX = 1.5
      TOO_FAR = 10
      GLOBAL_SHIFT = 0.1
      ITERATIONS = 80
      ANIMATION_SPEED = 1
      //take a double between 0 and 1 and returns integer between 0 and 255
      var projection = function(d) {
        return  Math.round(255* d)
      }
      // d is a double between 0 and 1
      var makeColorComponent = function(d) {
        r= projection(d).toString(16)
        if (r.length < 2)
          r = "0" + r
        return r
      }
      var cycleMap = function (x,shift,width) {
        return Math.sin((x + shift * width) * Math.PI * 2/width)/2 + 0.5;
      }
      //r,g,b are floats/doubles between 0 and 1
      var makeColor = function(r,g,b) {
        return "#" + makeColorComponent(r) + makeColorComponent(g) + makeColorComponent(b)       
      }
      var transform = function(x, pixels, minplot, maxplot) {
        return minplot + (x/pixels * (maxplot - minplot))
      }
      var xTransform = function(x, pixels, minplot, maxplot) {
        return transform(x,pixels,minplot,maxplot);
      }
      var yTransform = function(y, pixels, minplot, maxplot) {
        return -transform(y,pixels,-minplot,-maxplot);
      }
      var doit = function() {
        var tmp, zx, zy, x, y, sqrDistance, p, i;
        var r = document.getElementById("blah");
        var pixelRows = r.getAttribute("height");
        var pixelCols = r.getAttribute("width");
        var pixelCount = pixelRows * pixelCols
        var ctx = r.getContext("2d");
        ctx.fillStyle = "#000000";
        ctx.fillRect(0,0,pixelRows,pixelCols);
        var canvasData = ctx.getImageData(0, 0, pixelCols, pixelRows);
        var binaryData = canvasData.data;
        var red = []
        var green = []
        var blue = []
        var pixelColors = []
        for (p=0; p < pixelCount; p++) {
          pixelColors[p] = -1;
        }
        for (i=0; i < ITERATIONS; i++) {
          red[i]   = projection(cycleMap(i,GLOBAL_SHIFT,ITERATIONS));
          green[i] = projection(cycleMap(i,GLOBAL_SHIFT + 0.666666,ITERATIONS));
          blue[i]  = projection(cycleMap(i,GLOBAL_SHIFT + 0.333333,ITERATIONS));
        }
        var drawPixel = function(x,y,i) {
          var offset = (y+x*pixelCols) << 2;
          pixelColors[offset]  = i;
          binaryData[offset]   = red[i];
          binaryData[offset+1] = green[i];
          binaryData[offset+2] = blue[i];
          binaryData[offset+3] = 0xFF
        }
        var yTransforms = [];
        for (r=0; r < pixelRows; r++) {
          yTransforms[r] = yTransform(r, pixelRows, Y_MIN, Y_MAX);
        }

        for (c=0; c < pixelCols; c++) {
          x = xTransform(c, pixelCols, X_MIN, X_MAX)
          for (r=0; r < pixelRows; r++) {
            y = yTransforms[r];
            zx = x
            zy = y
            for (i = 0; i<ITERATIONS; i++) {
              // z = z*z
              tmp = zx*zx - zy*zy
              zy = 2*zx*zy
              zx = tmp

              // z = z + p
              zx = zx + x
              zy = zy + y

              //distance squared
              tmp = y-zy
              sqrDistance = tmp*tmp
              tmp = x-zy
              sqrDistance = sqrDistance + tmp*tmp;
              //sqrDistance = ((y-zy) * (y-zy) + (x-zx) * (x-zx))
              if (sqrDistance >= TOO_FAR) {
                drawPixel(r,c,i);
              }
            }
          }
        }
        ctx.putImageData(canvasData, 0, 0);
        var anim = function() {
          requestAnimationFrame(anim);
          for (p=0; p < pixelCount; p++) {
            offset = p << 2;
            i = pixelColors[offset];
            if (i < 0) continue;
            i = (i + ANIMATION_SPEED) % ITERATIONS
            binaryData[offset] = red[i];
            binaryData[offset+1] = green[i];
            binaryData[offset+2] = blue[i];
            pixelColors[offset] = i;
          }
          ctx.putImageData(canvasData, 0, 0);
        }
        anim();
      }
    </script>
  </head>
  <body onload="doit()">
    <canvas id="blah" width="50" height="50"></canvas>
  </body>
</html>
